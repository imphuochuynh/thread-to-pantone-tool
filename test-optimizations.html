<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #00ff00;
        }
        .pass { color: #00ff00; }
        .fail { color: #ff0000; }
    </style>
</head>
<body>
    <h1>Optimization Tests</h1>
    <div id="results"></div>

    <script type="module">
        import { rgbToLab, calculateColorDistance, findClosestColors, getCacheStats } from './colorMath.js';
        import { calculateStringSimilarity, buildColorMaps, filterColors } from './search.js';

        const results = document.getElementById('results');

        function addResult(name, passed, details) {
            const div = document.createElement('div');
            div.className = 'test-result';
            div.innerHTML = `
                <strong class="${passed ? 'pass' : 'fail'}">${passed ? '✓' : '✗'} ${name}</strong>
                <div>${details}</div>
            `;
            results.appendChild(div);
        }

        // Test 1: Pre-computed LAB values
        console.log('Test 1: Pre-computed LAB values');
        const testColor = { r: 255, g: 128, b: 64 };
        const lab = rgbToLab(testColor);
        const hasLab = lab && typeof lab.L === 'number' && typeof lab.a === 'number' && typeof lab.b === 'number';
        addResult('Pre-computed LAB values', hasLab, `LAB: L=${lab?.L?.toFixed(2)}, a=${lab?.a?.toFixed(2)}, b=${lab?.b?.toFixed(2)}`);

        // Test 2: Cache functionality
        console.log('Test 2: Cache functionality');
        const color1 = { rgb: { r: 255, g: 0, b: 0 }, lab: rgbToLab({ r: 255, g: 0, b: 0 }) };
        const color2 = { rgb: { r: 0, g: 255, b: 0 }, lab: rgbToLab({ r: 0, g: 255, b: 0 }) };

        // First call (should cache)
        const dist1 = calculateColorDistance(color1, color2, 'lab', false);
        // Second call (should use cache)
        const dist2 = calculateColorDistance(color1, color2, 'lab', false);

        const cacheStats = getCacheStats();
        const cacheWorks = dist1 === dist2 && cacheStats.size > 0;
        addResult('Memoization cache', cacheWorks, `Cache size: ${cacheStats.size}/${cacheStats.maxSize}, Distance: ${dist1.toFixed(2)}`);

        // Test 3: Optimized Levenshtein
        console.log('Test 3: Optimized Levenshtein');
        const start = performance.now();
        const similarity = calculateStringSimilarity('pantone123', 'pantone124');
        const time = performance.now() - start;
        const levenshteinWorks = similarity > 0 && similarity < 1 && time < 5; // Should be very fast
        addResult('Levenshtein optimization', levenshteinWorks, `Similarity: ${similarity.toFixed(3)}, Time: ${time.toFixed(2)}ms`);

        // Test 4: Hash map lookups
        console.log('Test 4: Hash map lookups');
        const testColors = [
            { type: 'thread', code: 'TEST-001', rgb: { r: 255, g: 0, b: 0 }, lab: rgbToLab({ r: 255, g: 0, b: 0 }) },
            { type: 'pantone', code: 'PANTONE 123', rgb: { r: 0, g: 255, b: 0 }, lab: rgbToLab({ r: 0, g: 255, b: 0 }) }
        ];
        buildColorMaps(testColors);

        const startMap = performance.now();
        const filtered = filterColors(testColors, 'TEST-001');
        const timeMap = performance.now() - startMap;
        const mapWorks = filtered.length === 1 && filtered[0].code === 'TEST-001' && timeMap < 5;
        addResult('Hash map lookups', mapWorks, `Found: ${filtered.length} colors, Time: ${timeMap.toFixed(2)}ms`);

        // Test 5: Overall performance check
        console.log('Test 5: Overall performance');
        const manyColors = [];
        for (let i = 0; i < 1000; i++) {
            const rgb = { r: Math.floor(Math.random() * 256), g: Math.floor(Math.random() * 256), b: Math.floor(Math.random() * 256) };
            manyColors.push({
                type: 'test',
                code: `TEST-${i}`,
                rgb: rgb,
                lab: rgbToLab(rgb)
            });
        }

        buildColorMaps(manyColors);

        const startSearch = performance.now();
        const searchResults = filterColors(manyColors, 'TEST-500');
        const timeSearch = performance.now() - startSearch;

        const perfGood = timeSearch < 10; // Should be very fast with hash map
        addResult('Performance with 1000 colors', perfGood, `Search time: ${timeSearch.toFixed(2)}ms, Found: ${searchResults.length} results`);

        // Summary
        addResult('All optimizations ready', true, 'System is optimized and ready for use!');
    </script>
</body>
</html>
